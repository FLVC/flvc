<?php

// $Id$

/**
 * @file
 * Collected FLVC hooks (maybe),  IID only now
 *
 */

/**
 * Implements hook_menu().
 */
function flvc_menu() {
  return array(
   'admin/islandora/tools/flvc' => array(
      'title' => 'FLVC Module Settings',
      'description' => 'Settings for FLVC Module.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('flvc_admin_form'),
      'access arguments' => array('administer islandora solr'),
      'file' => 'includes/admin.form.inc',
    ),
    'islandora/object/%islandora_object/toc' => array(
      'title' => 'Table of Contents',
      'type' => MENU_LOCAL_TASK,
      'page callback' => 'flvc_toc_menu',
      'page arguments' => array(2),
      'access callback' => 'flvc_toc_access_callback',
      'access arguments' => array(2),
    ),
    'islandora/tree_edit/%islandora_object/TOC' => array(
      'title' => 'Edit Table of Contents',
      'type' => MENU_CALLBACK,
      'page callback' => 'drupal_get_form',
      'page arguments' => array('flvc_toc_edit_form', 2),
      'access callback' => 'flvc_toc_edit_access_callback',
      'access arguments' => array(2),
    ),
    'islandora/object/%islandora_object/report' => array(
      'title' => 'Report',
      'type' => MENU_LOCAL_TASK,
      'page callback' => 'drupal_get_form',
      'page arguments' => array('flvc_report_form',2),
      'access callback' => 'flvc_report_access_callback',
      'access arguments' => array(2),
    ),
    'islandora/object/%islandora_object/report/results' => array(
      'title' => 'Report Results',
      'type' => MENU_CALLBACK,
      'page callback' => 'flvc_report_results',
      'page arguments' => array(2),
      'access callback' => 'flvc_report_access_callback',
      'access arguments' => array(2),
    ),
    'islandora_solr/autocomplete_text_fields' => array(
      'title' => 'Islandora Solr Luke autocomplete',
      'description' => 'Autocomplete callback to populate solr text fields.',
      'page callback' => 'flvc_solr_autocomplete_text_fields',
      'access arguments' => array(ISLANDORA_METADATA_EDIT),
      'type' => MENU_CALLBACK,
    ),
    'islandora_solr/autocomplete_string_fields' => array(
      'title' => 'Islandora Solr Luke autocomplete',
      'description' => 'Autocomplete callback to populate solr string fields.',
      'page callback' => 'flvc_solr_autocomplete_string_fields',
      'access arguments' => array(ISLANDORA_METADATA_EDIT),
      'type' => MENU_CALLBACK,
    ),
/*
    'admin/reports/google-analytics-all-views' => array(
      'title' => 'Google Analytics Views',
      'description' => "Views based on traffic data for your site.",
      'page callback' => 'flvc_google_analytics_all_views',
      'access arguments' => array(ISLANDORA_METADATA_EDIT),
      'type' => MENU_NORMAL_ITEM,
    ),
    'islandora/reports/google-analytics-all-views' => array(
      'title' => 'Google Analytics Views',
      'description' => "Views based on traffic data for your site.",
      'page callback' => 'flvc_google_analytics_all_views',
      'access arguments' => array(ISLANDORA_METADATA_EDIT),
      'type' => MENU_NORMAL_ITEM,
    ),
*/
  );
}

/**
 * Implements hook_theme().
 */
function flvc_theme() {
  return array(
    'flvc_toc' => array(
      'arguments' => array('object' => NULL),
      'file' => 'theme/theme.inc',
      'template' => 'theme/islandora-toc',
    ),
    'flvc_toc_edit' => array(
      'arguments' => array('object' => NULL),
      'file' => 'theme/theme.inc',
      'template' => 'theme/islandora-toc-edit',
    ),
  );
}

/**
 * Determine whether or not to show this modules table of contents tab.
 *
 * @param FedoraObject $object
 *   The book object.
 *
 * @return bool
 *   TRUE if it should be shown, and FALSE if it should not be shown.
 */
function flvc_toc_access_callback($object = NULL) {
  if (!isset($object)) {
    return FALSE;
  }
  $is_book = in_array('islandora:bookCModel', $object->models);
  $is_issue = in_array('islandora:newspaperIssueCModel', $object->models);
  $is_toc = isset($object['TOC']);
  return ($is_book || $is_issue) && $is_toc && islandora_object_access_callback(ISLANDORA_VIEW_OBJECTS, $object);
}

/**
 * Determine whether or not to show this modules table of contents tab.
 *
 * @param FedoraObject $object
 *   The book object.
 *
 * @return bool
 *   TRUE if it should be shown, and FALSE if it should not be shown.
 */
function flvc_toc_edit_access_callback($object = NULL) {
  if (!isset($object)) {
    return FALSE;
  }
  $is_book = in_array('islandora:bookCModel', $object->models);
  $is_issue = in_array('islandora:newspaperIssueCModel', $object->models);
  $is_toc = isset($object['TOC']);
  return ($is_book || $is_issue) && $is_toc && user_has_role(user_role_load_by_name('administrator')->rid) && islandora_object_access_callback(ISLANDORA_METADATA_EDIT, $object);
}

/**
 * Renders the Table of Contents local menu task.
 *
 * @param FedoraObject $object
 *   The book object to fetch the pages from.
 *
 * @return string
 *   The HTML repersentation of the given books pages.
 */
function flvc_toc_menu(FedoraObject $object) {
  return theme('flvc_toc', array('object' => $object));
}

function flvc_toc_edit_form(array $form, array &$form_state, AbstractObject $object) {

  $form_state['object'] = $object;

  $toc_string = $object['TOC']->content;

  $form['toctext'] = array(
    '#title' => t('TOC'),
    '#type' => 'textarea',
    '#rows' => 30,
    '#cols' => 100,
    '#default_value' => $toc_string,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Update')
  );

  return $form;
}

function flvc_toc_edit_form_submit($form, &$form_state) {
    $tab = "  ";
    $new_json = "";
    $indent_level = 0;
    $in_string = false; 

  $object = $form_state['object'];
  $form_state['redirect'] = "islandora/object/{$object->id}";
  $new_toc = $form_state['values']['toctext'];

  $toc_entries = array();
  $toc_entries = drupal_json_decode($new_toc, true);

  $new_sequence_num = 1;

  $last_sequence_num = 1;

  for ($i=0; $i < count($toc_entries['table_of_contents']); $i++) {

    $old_sequence_num = intval($toc_entries['table_of_contents'][$i]['pagenum']);
    if (($i > 0)&&($old_sequence_num != $last_sequence_num)) {
      $new_sequence_num++;
    }
    $last_sequence_num = $old_sequence_num;
    $toc_entries['table_of_contents'][$i]['pagenum'] = $new_sequence_num;

  }

  $json = drupal_json_encode($toc_entries);

    $len = strlen($json);

    for($c = 0; $c < $len; $c++)
    {
        $char = $json[$c];
        switch($char)
        {
            case '{':
            case '[':
                if(!$in_string)
                {
                    $new_json .= $char . "\n" . str_repeat($tab, $indent_level+1);
                    $indent_level++;
                }
                else
                {
                    $new_json .= $char;
                }
                break;
            case '}':
            case ']':
                if(!$in_string)
                {
                    $indent_level--;
                    $new_json .= "\n" . str_repeat($tab, $indent_level) . $char;
                }
                else
                {
                    $new_json .= $char;
                }
                break;
            case ',':
                if(!$in_string)
                {
                    $new_json .= ",\n" . str_repeat($tab, $indent_level);
                }
                else
                {
                    $new_json .= $char;
                }
                break;
            case ':':
                if(!$in_string)
                {
                    $new_json .= ": ";
                }
                else
                {
                    $new_json .= $char;
                }
                break;
            case '"':
                if($c > 0 && $json[$c-1] != '\\')
                {
                    $in_string = !$in_string;
                }
            default:
                $new_json .= $char;
                break;                   
        }
    } 

  try {
    $ds = $object['TOC'];
    //$ds->setContentFromString(str_replace("{","\n{",$json));
    $ds->setContentFromString($new_json);
  }
  catch (exception $e) {
    drupal_set_message(t('An error occurred during TOC datastream update. See watchlog for more information.'), 'error');
    watchdog('islandora',
      'Failed to update TOC datastream.<br/>code: @code<br/>message: @msg',
      array(
        '@code' => $e->getCode(),
        '@msg' => $e->getMessage(),
      ),
      WATCHDOG_ERROR
    );
    return;
  }
  drupal_set_message(t("Successfully Updated TOC Datastream"));
  
}

function flvc_report_access_callback($object = NULL) {
  if (!isset($object)) {
    return FALSE;
  }
  return in_array('islandora:collectionCModel', $object->models) && islandora_object_access_callback(ISLANDORA_METADATA_EDIT, $object);
}

function flvc_report_form(array $form, array &$form_state, AbstractObject $object) {

  $form_state['object'] = $object;

  $form['report_desc'] = array(
      '#type' => 'markup',
      '#markup' => '<h3>' . $object->label . '</h3>Report of object counts for this collection and any child collections, grouped by content model.  Select the checkbox to download a CSV file of the report.<br><br>',
  );

  $form['show_br'] = array(
      '#type' => 'markup',
      '#markup' => 'Optional - enter beginning and/or ending create dates:<br>',
  );

  $form['createdate1'] = array(
      '#size' => '10',
      '#type' => 'textfield',
      '#title' => 'Created from date (YYYY-MM-DD):',
      '#default_value' => '',
  );

  $form['createdate2'] = array(
      '#size' => '10',
      '#type' => 'textfield',
      '#title' => 'Created to date (YYYY-MM-DD):',
      '#default_value' => '',
  );

  $form['show_br_2'] = array(
      '#type' => 'markup',
      '#markup' => '<br>Optional - search Solr field:<br>',
  );

  $form['search'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array(
        'container-inline')
      )
  );

  $form['search']['solrfield'] = array(
    '#size' => '45',
    '#type' => 'textfield',
    '#title' => '',
    '#autocomplete_path' => 'islandora_solr/autocomplete_text_fields',
    '#default_value' => '',
  );

  $form['search']['solrsearch'] = array(
    '#size' => '20',
    '#type' => 'textfield',
    '#title' => '',
    '#default_value' => '',
  );

  $form['show_br_3'] = array(
      '#type' => 'markup',
      '#markup' => '<br>',
  );

  $form['download_csv_file'] = array(
    '#type' => 'checkbox',
    '#title' => t('Download a csv file'),
    '#description' => t('Download a CSV file.'),
    '#default_value' => FALSE,
  );

  $form['show_br_4'] = array(
      '#type' => 'markup',
      '#markup' => '<br>',
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Generate Report')
  );

  return $form;
}

function flvc_report_form_submit($form, &$form_state) {
  $object = $form_state['object'];
  $createdate1 = $form_state['values']['createdate1'];
  $createdate2 = $form_state['values']['createdate2'];
  $solrfield = $form_state['values']['solrfield'];
  $solrsearch = $form_state['values']['solrsearch'];
  $downloadcsv = $form_state['values']['download_csv_file'];
  $params = array();
  if (strlen($createdate1) > 0) {
    $params = array_merge($params, array('cdate1' => $createdate1));
  }
  if (strlen($createdate2) > 0) {
    $params = array_merge($params, array('cdate2' => $createdate2));
  }
  if ((strlen($solrfield) > 0)&&(strlen($solrsearch) > 0)) {
    $params = array_merge($params, array('solrfield' => str_replace('.','_',$solrfield) . '_mt', 'solrsearch' => $solrsearch));
  }
  if ($downloadcsv) {
    $params = array_merge($params, array('csv' => 'true'));
  }
  $form_state['redirect'] = array('islandora/object/' . $object->id . '/report/results', array('query' => $params));
}

function flvc_report_results(FedoraObject $object) {

  $downloadcsv = isset($_GET['csv']) ? true : false;
  $createdate1 = isset($_GET['cdate1']) ? $_GET['cdate1'] : '';
  $createdate2 = isset($_GET['cdate2']) ? $_GET['cdate2'] : '';
  $datefilter = '';
  if ((strlen($createdate1) > 0)&&(strlen($createdate2) > 0)) {
      $datefilter = 'fgs_createdDate_dt:[' . $createdate1 . 'T00:00:00Z TO ' . $createdate2 . 'T00:00:00Z]';
  }
  else if ((strlen($createdate1) == 0)&&(strlen($createdate2) > 0)) {
      $datefilter = 'fgs_createdDate_dt:[* TO ' . $createdate2 . 'T00:00:00Z]';
  }
  else if ((strlen($createdate1) > 0)&&(strlen($createdate2) == 0)) {
      $datefilter = 'fgs_createdDate_dt:[' . $createdate1 . 'T00:00:00Z TO ' . date('Y-m-d') . 'T00:00:00Z]';
  }

  $solrquery = '*:*';
  $solrfield = isset($_GET['solrfield']) ? $_GET['solrfield'] : '';
  $solrsearch = isset($_GET['solrsearch']) ? $_GET['solrsearch'] : '';
  if ((strlen($solrfield) > 0)&&(strlen($solrsearch) > 0)) {
    $solrquery = $solrfield . ':' . $solrsearch;
  }

  $content_models = array(
    'islandora:collectionCModel',
    'islandora:sp-audioCModel',
    'islandora:sp_basic_image',
    'islandora:binaryObjectCModel',
    'islandora:bookCModel',
    'ir:citationCModel',
    'islandora:compoundCModel',
    'islandora:sp_large_image_cmodel',
    'islandora:newspaperCModel',
    'islandora:sp_pdf',
    'islandora:rootSerialCModel',
    'ir:thesisCModel',
    'islandora:sp_videoCModel',
  );

  $parsed_url = parse_url(variable_get('islandora_solr_url', 'http://localhost:8080/solr'));
  $solr = new Apache_Solr_Service($parsed_url['host'], $parsed_url['port'], $parsed_url['path']);

  $msg = 'collection id, audio, basic image, binary, book, collection, compound, large image, newspaper, pdf, serial, video' . "\n";
  $collections = array();
  $collections[] = $object->id;
  $rc = get_child_collections($object->id, $collections);
  sort($collections);

  $header = array();
  $header[] = array('data' => t('collection ID'));
  $header[] = array('data' => t('collection'));
  $header[] = array('data' => t('audio'));
  $header[] = array('data' => t('basic image'));
  $header[] = array('data' => t('binary'));
  $header[] = array('data' => t('book'));
  $header[] = array('data' => t('book page'));
  $header[] = array('data' => t('citation'));
  $header[] = array('data' => t('compound'));
  $header[] = array('data' => t('large image'));
  $header[] = array('data' => t('newspaper'));
  $header[] = array('data' => t('newspaper issue'));
  $header[] = array('data' => t('newspaper page'));
  $header[] = array('data' => t('pdf'));
  $header[] = array('data' => t('serial'));
  $header[] = array('data' => t('serial component'));
  $header[] = array('data' => t('serial pdf'));
  $header[] = array('data' => t('thesis'));
  $header[] = array('data' => t('video'));
  $header[] = array('data' => t('total per collection'));
  $rows = array();
  $csv_rows = array();
  $csv_row = array();
  $csv_header[] = 'collection ID';
  $csv_header[] = 'collection';
  $csv_header[] = 'audio';
  $csv_header[] = 'basic image';
  $csv_header[] = 'binary';
  $csv_header[] = 'book';
  $csv_header[] = 'book page';
  $csv_header[] = 'citation';
  $csv_header[] = 'compound';
  $csv_header[] = 'large image';
  $csv_header[] = 'newspaper';
  $csv_header[] = 'newspaper issue';
  $csv_header[] = 'newspaper page';
  $csv_header[] = 'pdf';
  $csv_header[] = 'serial';
  $csv_header[] = 'serial component';
  $csv_header[] = 'serial pdf';
  $csv_header[] = 'thesis';
  $csv_header[] = 'video';
  $csv_header[] = 'total per collection';
  $csv_rows[] = $csv_header;

  $total_sum = 0;
  $content_model_count = array(
    'islandora:collectionCModel' => 0,
    'islandora:sp-audioCModel' => 0,
    'islandora:sp_basic_image' => 0,
    'islandora:binaryObjectCModel' => 0,
    'islandora:bookCModel' => 0,
    'book page' => 0,
    'ir:citationCModel' => 0,
    'islandora:compoundCModel' => 0,
    'islandora:sp_large_image_cmodel' => 0,
    'islandora:newspaperCModel' => 0,
    'newspaper issue' => 0,
    'newspaper page' => 0,
    'islandora:sp_pdf' => 0,
    'islandora:rootSerialCModel' => 0,
    'serial intermediate' => 0,
    'serial pdf' => 0,
    'ir:thesisCModel' => 0,
    'islandora:sp_videoCModel' => 0,
  );

  foreach ($collections as $collection) {
    $msg .= $collection;
    $total_count = 0;
    $row = array();
    $csv_row = array();
    $row[] = array('data' => $collection);
    $csv_row[] = $collection;

    foreach ($content_models as $content_model) {
      $filters = array();
      $filters[] = 'RELS_EXT_isMemberOfCollection_uri_ms:info\:fedora/' . str_replace(':','\:',$collection);
      $filters[] = 'RELS_EXT_hasModel_uri_ms:info\:fedora/' . str_replace(':','\:',$content_model);
      if ($content_model == 'islandora:compoundCModel') {
        $filters[] = '-RELS_EXT_isConstituentOf_uri_mt:*';
      }

      // make sure we can query with no date filter for retrieving parent objects for child object counts
      $params_no_date = array(
        'rows' => 0,
        'qt' => variable_get('islandora_solr_request_handler', 'standard'),
        'fq' => $filters,
      );

      if (strlen($datefilter) > 0) {
        $filters[] = $datefilter;
      }
      $params = array(
        'rows' => 0,
        'qt' => variable_get('islandora_solr_request_handler', 'standard'),
        'fq' => $filters,
      );

      // Solr results in JSON format.
      $result_object = json_decode($solr->search($solrquery, 0, 0, $params)->getRawResponse(), TRUE);

      $count = $result_object['response']['numFound'];
      $msg .= ',' . $count;
      $row[] = array('data' => $count);
      $csv_row[] = $count;
      $content_model_count[$content_model] += $count;
      $total_count += $count;

      // if book
      if ($content_model == 'islandora:bookCModel') {
        $book_results = json_decode($solr->search($solrquery, 0, 0, $params_no_date)->getRawResponse(), TRUE);
        $book_count_no_date = $book_results['response']['numFound'];
        $params_no_date['fl'] = 'PID';
        $book_results = json_decode($solr->search($solrquery, 0, $book_count_no_date, $params_no_date)->getRawResponse(), TRUE);

        // loop through results
        $page_count = 0;
        foreach ($book_results['response']['docs'] as $doc) {
          
          // query for page counts for each book
          $page_filters = array();
          $page_filters[] = 'parent_book_id_ms:info\:fedora/' . str_replace(':','\:',$doc['PID']);
          $page_filters[] = 'RELS_EXT_hasModel_uri_ms:info\:fedora/islandora\:pageCModel';
          if (strlen($datefilter) > 0) {
            $page_filters[] = $datefilter;
          }
          $page_params = array(
            'rows' => 0,
            'qt' => variable_get('islandora_solr_request_handler', 'standard'),
            'fq' => $page_filters,
          );
          $page_results = json_decode($solr->search($solrquery, 0, 0, $page_params)->getRawResponse(), TRUE);
          // keep a running total
          $page_count += $page_results['response']['numFound'];
        }
        // display total
        $msg .= ',' . $page_count;
        $row[] = array('data' => $page_count);
        $csv_row[] = $page_count;
        $content_model_count['book page'] += $page_count;
        $total_count += $page_count;
      }

      // if newspaper
      if ($content_model == 'islandora:newspaperCModel') {
        $newspaper_results = json_decode($solr->search($solrquery, 0, 0, $params_no_date)->getRawResponse(), TRUE);
        $newspaper_count_no_date = $newspaper_results['response']['numFound'];
        $params_no_date['fl'] = 'PID';
        $newspaper_results = json_decode($solr->search($solrquery, 0, $newspaper_count_no_date, $params_no_date)->getRawResponse(), TRUE);

        // loop through results to get newspaper issue count
        $newspaper_issue_count = 0;
        foreach ($newspaper_results['response']['docs'] as $doc) {

          // query for issue counts for each newspaper
          $newspaper_issue_filters = array();
          $newspaper_issue_filters[] = 'parent_newspaper_id_ms:info\:fedora/' . str_replace(':','\:',$doc['PID']);
          $newspaper_issue_filters[] = 'RELS_EXT_hasModel_uri_ms:info\:fedora/islandora\:newspaperIssueCModel';
          if (strlen($datefilter) > 0) {
            $newspaper_issue_filters[] = $datefilter;
          }
          $newspaper_issue_params = array(
            'rows' => 0,
            'qt' => variable_get('islandora_solr_request_handler', 'standard'),
            'fq' => $newspaper_issue_filters,
          );
          $newspaper_issue_results = json_decode($solr->search($solrquery, 0, 0, $newspaper_issue_params)->getRawResponse(), TRUE);
          // keep a running total
          $newspaper_issue_count += $newspaper_issue_results['response']['numFound'];
        }
        // display total
        $msg .= ',' . $newspaper_issue_count;
        $row[] = array('data' => $newspaper_issue_count);
        $csv_row[] = $newspaper_issue_count;
        $content_model_count['newspaper issue'] += $newspaper_issue_count;
        $total_count += $newspaper_issue_count;

        // loop through results to get newspaper page count
        $newspaper_page_count = 0;
        foreach ($newspaper_results['response']['docs'] as $doc) {

          // query for page counts for each newspaper
          $newspaper_page_filters = array();
          $newspaper_page_filters[] = 'parent_newspaper_id_ms:info\:fedora/' . str_replace(':','\:',$doc['PID']);
          $newspaper_page_filters[] = 'RELS_EXT_hasModel_uri_ms:info\:fedora/islandora\:newspaperPageCModel';
          if (strlen($datefilter) > 0) {
            $newspaper_page_filters[] = $datefilter;
          }
          $newspaper_page_params = array(
            'rows' => 0,
            'qt' => variable_get('islandora_solr_request_handler', 'standard'),
            'fq' => $newspaper_page_filters,
          );
          $newspaper_page_results = json_decode($solr->search($solrquery, 0, 0, $newspaper_page_params)->getRawResponse(), TRUE);
          // keep a running total
          $newspaper_page_count += $newspaper_page_results['response']['numFound'];
        }
        // display total
        $msg .= ',' . $newspaper_page_count;
        $row[] = array('data' => $newspaper_page_count);
        $csv_row[] = $newspaper_page_count;
        $content_model_count['newspaper page'] += $newspaper_page_count;
        $total_count += $newspaper_page_count;
      }

      if ($content_model == 'islandora:rootSerialCModel') {
        $serial_results = json_decode($solr->search($solrquery, 0, 0, $params_no_date)->getRawResponse(), TRUE);
        $serial_count_no_date = $serial_results['response']['numFound'];
        $params_no_date['fl'] = 'PID';
        $serial_results = json_decode($solr->search($solrquery, 0, $serial_count_no_date, $params_no_date)->getRawResponse(), TRUE);

        // loop through results
        $intermediate_count = 0;
        foreach ($serial_results['response']['docs'] as $doc) {

          // query for intermediate counts for each book
          $intermediate_filters = array();
          $intermediate_filters[] = 'parent_serial_id_ms:info\:fedora/' . str_replace(':','\:',$doc['PID']);
          $intermediate_filters[] = 'RELS_EXT_hasModel_uri_ms:info\:fedora/islandora\:intermediateCModel';
          if (strlen($datefilter) > 0) {
            $intermediate_filters[] = $datefilter;
          }
          $intermediate_params = array(
            'rows' => 0,
            'qt' => variable_get('islandora_solr_request_handler', 'standard'),
            'fq' => $intermediate_filters,
          );
          $intermediate_results = json_decode($solr->search($solrquery, 0, 0, $intermediate_params)->getRawResponse(), TRUE);
          // keep a running total
          $intermediate_count += $intermediate_results['response']['numFound'];
        }
        // display total
        $msg .= ',' . $intermediate_count;
        $row[] = array('data' => $intermediate_count);
        $csv_row[] = $intermediate_count;
        $content_model_count['serial intermediate'] += $intermediate_count;
        $total_count += $intermediate_count;
        
        // loop through results
        $serial_pdf_count = 0;
        foreach ($serial_results['response']['docs'] as $doc) {

          // query for intermediate counts for each book
          $serial_pdf_filters = array();
          $serial_pdf_filters[] = 'parent_serial_id_ms:info\:fedora/' . str_replace(':','\:',$doc['PID']);
          $serial_pdf_filters[] = 'RELS_EXT_hasModel_uri_ms:info\:fedora/islandora\:sp_pdf';
          if (strlen($datefilter) > 0) {
            $serial_pdf_filters[] = $datefilter;
          }
          $serial_pdf_params = array(
            'rows' => 0,
            'qt' => variable_get('islandora_solr_request_handler', 'standard'),
            'fq' => $serial_pdf_filters,
          );
          $serial_pdf_results = json_decode($solr->search($solrquery, 0, 0, $serial_pdf_params)->getRawResponse(), TRUE);
          // keep a running total
          $serial_pdf_count += $serial_pdf_results['response']['numFound'];
        }
        // display total
        $msg .= ',' . $serial_pdf_count;
        $row[] = array('data' => $serial_pdf_count);
        $csv_row[] = $serial_pdf_count;
        $content_model_count['serial pdf'] += $serial_pdf_count;
        $total_count += $serial_pdf_count;
      }

    }
    $msg .= "\n";
    //$row[] = $total_count;
    $total_sum += $total_count;
    $row[] = array('data' => $total_count);
    $rows[] = $row;
    $csv_row[] = $total_count;
    $csv_rows[] = $csv_row;
  }

  $total_row = array();
  $total_row[] = array('data' => "total per content model");
  $total_row[] = array('data' => $content_model_count['islandora:collectionCModel']);
  $total_row[] = array('data' => $content_model_count['islandora:sp-audioCModel']);
  $total_row[] = array('data' => $content_model_count['islandora:sp_basic_image']);
  $total_row[] = array('data' => $content_model_count['islandora:binaryObjectCModel']);
  $total_row[] = array('data' => $content_model_count['islandora:bookCModel']);
  $total_row[] = array('data' => $content_model_count['book page']);
  $total_row[] = array('data' => $content_model_count['ir:citationCModel']);
  $total_row[] = array('data' => $content_model_count['islandora:compoundCModel']);
  $total_row[] = array('data' => $content_model_count['islandora:sp_large_image_cmodel']);
  $total_row[] = array('data' => $content_model_count['islandora:newspaperCModel']);
  $total_row[] = array('data' => $content_model_count['newspaper issue']);
  $total_row[] = array('data' => $content_model_count['newspaper page']);
  $total_row[] = array('data' => $content_model_count['islandora:sp_pdf']);
  $total_row[] = array('data' => $content_model_count['islandora:rootSerialCModel']);
  $total_row[] = array('data' => $content_model_count['serial intermediate']);
  $total_row[] = array('data' => $content_model_count['serial pdf']);
  $total_row[] = array('data' => $content_model_count['ir:thesisCModel']);
  $total_row[] = array('data' => $content_model_count['islandora:sp_videoCModel']);
  $total_row[] = array('data' => $total_sum);

  $rows[] = $total_row;

  $csv_total_row = array();
  $csv_total_row[] = 'total per content model';
  $csv_total_row[] = $content_model_count['islandora:collectionCModel'];
  $csv_total_row[] = $content_model_count['islandora:sp-audioCModel'];
  $csv_total_row[] = $content_model_count['islandora:sp_basic_image'];
  $csv_total_row[] = $content_model_count['islandora:binaryObjectCModel'];
  $csv_total_row[] = $content_model_count['islandora:bookCModel'];
  $csv_total_row[] = $content_model_count['book page'];
  $csv_total_row[] = $content_model_count['ir:citationCModel'];
  $csv_total_row[] = $content_model_count['islandora:compoundCModel'];
  $csv_total_row[] = $content_model_count['islandora:sp_large_image_cmodel'];
  $csv_total_row[] = $content_model_count['islandora:newspaperCModel'];
  $csv_total_row[] = $content_model_count['newspaper issue'];
  $csv_total_row[] = $content_model_count['newspaper page'];
  $csv_total_row[] = $content_model_count['islandora:sp_pdf'];
  $csv_total_row[] = $content_model_count['islandora:rootSerialCModel'];
  $csv_total_row[] = $content_model_count['serial intermediate'];
  $csv_total_row[] = $content_model_count['serial pdf'];
  $csv_total_row[] = $content_model_count['ir:thesisCModel'];
  $csv_total_row[] = $content_model_count['islandora:sp_videoCModel'];
  $csv_total_row[] = $total_sum;
  $csv_rows[] = $csv_total_row;

  if ($downloadcsv) {
    flvc_download_csv($csv_rows);
  }
  $output = theme('table', array('header' => $header, 'rows' => $rows));
  return $output;
}

function get_child_collections($collection_pid, &$collections) {
    $results_count = 0;
    $fedora_object = islandora_object_load(variable_get('islandora_repository_pid', 'islandora:root'));
    $query = <<<'EOQ'
SELECT ?subject
FROM <#ri>
WHERE {
  ?subject <fedora-model:hasModel> <info:fedora/islandora:collectionCModel>;
           <fedora-rels-ext:isMemberOfCollection> <info:fedora/!pid>;
           <fedora-model:state> <info:fedora/fedora-system:def/model#Active> .
}
EOQ;
    $formatted_query = format_string($query, array(
      '!pid' => $collection_pid,
    ));
    $results = $fedora_object->repository->ri->sparqlQuery($formatted_query, 'unlimited');
    $results_count = count($results);
    foreach ($results as $result) {
      $collections[] = $result['subject']['value'];
      $rc = get_child_collections($result['subject']['value'], $collections);
    }
    return $results_count;
}

function flvc_download_csv($rows) {
  global $user;
  $export_uri = 'public://csv_report_' . time() . '.csv';
  // We register this file into Drupal so it will be deleted.
  $file = new stdClass();
  $file->fid = NULL;
  $file->uri = $export_uri;
  $file->filename = drupal_basename($export_uri);
  $file->filemime = file_get_mimetype($file->uri);
  $file->uid = $user->uid;
  $fp = fopen($export_uri, 'w');
  foreach ($rows as $row) {
    fputcsv($fp, $row);
  }

  fclose($fp);
  drupal_set_message(filter_xss(t('The exported CSV report is available for download !url.', array(
    '!url' => l(t('here'), file_create_url($export_uri)),
  ))));
}

function flvc_form_alter(&$form, $form_state, $form_id) {

  if ($form_id == 'islandora_ingest_form')
  {
    if ($form['form_step_id']['#value'] == 'xml_form_builder_metadata_step')
    {
      $form['#validate'][] = 'iid_validate_ingest';
    }
  }

  if ($form_id == 'xml_form_builder_datastream_form')
  {
      if (!isset($form['available_forms']))
      {
          $form['#validate'][] = 'iid_validate_edit';
      }
  }
}

function iid_validate_ingest($form, &$form_state) {

  $errmsg = 'The following IID identifiers already exist: ';
  $error_IID_numbers = '';
  $error_IID_badchars = '';
  $error_IID_bsh = '';


  // do not validate if no flvc extension with owning institution
  if (!isset($form['extension']['flvc']['owningInst']['#value'])) {
      return;
  }

  $identifier_count = 0;
  if (isset($form['id'])) {
      $identifier_count = count($form['id']);
  }

  $iid_count = 0;
  for ($i=0; $i<$identifier_count; $i++)
  {
    if ( (isset($form['id'][$i]['identifier']['#value']))&&(isset($form['id'][$i]['type']['#value']))&&(strcasecmp(trim($form['id'][$i]['type']['#value']), 'IID') == 0)&&(strlen(trim($form['id'][$i]['identifier']['#value'])) > 0) )
    {
      $iid_count += 1;

      if (preg_match("/[^A-Za-z0-9_\-()\.]/", $form['id'][$i]['identifier']['#value'])) {
        $error_IID_badchars .= $form['id'][$i]['identifier']['#value'] . ' ';
      }

      if (strpos($form['id'][$i]['identifier']['#value'], "bsh") !== false) {
        $error_IID_bsh .= $form['id'][$i]['identifier']['#value'] . ' ';
      }

      $solr_url = "http://localhost:8080/solr/select/?version=2.2&start=0&rows=10&indent=on&fl=PID&wt=json&q=mods_identifier_iid_mls%3A" . urlencode(escapeSolrValue(trim($form['id'][$i]['identifier']['#value'])));

      $results = file_get_contents($solr_url);
      $solr_results = array();
      if (isset($results)) {
          $solr_results = json_decode($results, TRUE);
          $numfound = $solr_results['response']['numFound'];
          if ($numfound > 0) {
              //form_set_error('', t('The IID identifier %iidnum already exists.', array('%iidnum' => $form['id'][$i]['identifier']['#value'])));
              $error_IID_numbers = $error_IID_numbers . $form['id'][$i]['identifier']['#value'] . ' ';
          }
      }
    }
  }

  if ($iid_count == 0) {
    form_set_error('', t('You must enter an IID identifier.'));
  }

  if (strlen($error_IID_badchars) > 0) {
    form_set_error('', t('The following IID identifiers have illegal characters (characters can be alphanumeric, underscore, hyphen, period, or parentheses with no spaces): %iidnums', array('%iidnums' => $error_IID_badchars)));
  }

  if (strlen($error_IID_bsh) > 0) {
    form_set_error('', t('The following IID identifiers contain the illegal character string "bsh" (please uppercase or replace with other characters): %iidnums', array('%iidnums' => $error_IID_bsh)));
  }

  if (strlen($error_IID_numbers) > 0) {
    form_set_error('', t('The following IID identifiers already exist: %iidnums', array('%iidnums' => $error_IID_numbers)));
  }

  // other identifiers of type=IID are not allowed
  $other_identifier_count = 0;
  if (isset($form['id_otheridentifiers'])) {
      $other_identifier_count = count($form['id_otheridentifiers']);
  }
  $other_iid_count = 0;
  $error_other_IID_numbers = '';
  for ($i=0; $i<$other_identifier_count; $i++)
  {
    if ( (isset($form['id_otheridentifiers'][$i]['identifier']['#value']))&&(isset($form['id_otheridentifiers'][$i]['type']['#value']))&&(strcasecmp(trim($form['id_otheridentifiers'][$i]['type']['#value']), 'IID') == 0)&&(strlen(trim($form['id_otheridentifiers'][$i]['identifier']['#value'])) > 0) )
    {
      $other_iid_count += 1;
      $error_other_IID_numbers = $error_other_IID_numbers . $form['id_otheridentifiers'][$i]['identifier']['#value'] . ' ';
    }
  }
  if ($other_iid_count > 0) {
    form_set_error('', t('Additional IID identifiers are not allowed.  Change the type for the following identifiers: %iidnums', array('%iidnums' => $error_other_IID_numbers)));
  }

  // check format of purls
  $server_error_purls = '';
  $error_purls = '';

  $location_count = 0;
  if (isset($form['location'])) {
      $location_count = count($form['location']);
  }

  $purl_count = 0;
  for ($i=0; $i<$location_count; $i++)
  {
    if ( (isset($form['location'][$i]['locDispLabel']['#value']))&&(isset($form['location'][$i]['URL']['#value']))&&(strcasecmp($form['location'][$i]['locDispLabel']['#value'], 'PURL') == 0)&&(strlen(trim($form['location'][$i]['URL']['#value'])) > 0) )
    {
      $purl_count += 1;
      $url = trim($form['location'][$i]['URL']['#value']);
      if ((strpos($url,'http://purl.flvc.org') === false)&&(strpos($url,'http://purl.fcla.edu') === false)) {
          $server_error_purls = $server_error_purls . $url . ' ';
      }
      else {
          $purl_id = str_replace('http://purl.flvc.org','',str_replace('http://purl.fcla.edu','',$url));
          $hoststr = '/' . $form['extension']['flvc']['owningInst']['#value'] . '/';
          if (stripos($purl_id,$hoststr) !== 0) {
              $error_purls = $error_purls . $url . ' ';
          }
      }
    }
  }

  if (strlen($server_error_purls) > 0) {
    form_set_error('', t('The following PURLs have incorrect server names: %badpurls.  Allowable server names are http://purl.flvc.org or http://purl.fcla.edu only.', array('%badpurls' => $server_error_purls)));
  }

  if (strlen($error_purls) > 0) {
    form_set_error('', t('Allowable PURL domains are %domains.  The following PURLs have incorrect formats: %badpurls', array('%domains' => $form['extension']['flvc']['owningInst']['#value'], '%badpurls' => $error_purls)));
  }

}

function iid_validate_edit($form, &$form_state) {

  $error_IID_numbers = '';
  $error_IID_badchars = '';
  $error_IID_bsh = '';

  // do not validate if no flvc extension with owning institution
  if (!isset($form['extension']['flvc']['owningInst']['#value'])) {
      return;
  }

  $identifier_count = 0;
  if (isset($form['id'])) {
      $identifier_count = count($form['id']);
  }

  $form_action = explode('/',$form['#action']);
  $edit_object_pid = urldecode($form_action[3]);

  $object = islandora_object_load($edit_object_pid);
  if (in_array('islandora:intermediateCModel', $object->models)) {
    return;
  }

  $iid_count = 0;
  for ($i=0; $i<$identifier_count; $i++)
  {
    if ( (isset($form['id'][$i]['identifier']['#value']))&&(isset($form['id'][$i]['type']['#value']))&&(strcasecmp(trim($form['id'][$i]['type']['#value']), 'IID') == 0)&&(strlen(trim($form['id'][$i]['identifier']['#value'])) > 0) )
    {
      $iid_count += 1;

      if (preg_match("/[^A-Za-z0-9_\-()\.]/", $form['id'][$i]['identifier']['#value'])) {
        $error_IID_badchars .= $form['id'][$i]['identifier']['#value'] . ' ';
      }

      if (strpos($form['id'][$i]['identifier']['#value'], "bsh") !== false) {
        $error_IID_bsh .= $form['id'][$i]['identifier']['#value'] . ' ';
      }

      $solr_url = "http://localhost:8080/solr/select/?version=2.2&start=0&rows=10&indent=on&fl=PID&wt=json&q=mods_identifier_iid_mls%3A" . urlencode(escapeSolrValue(trim($form['id'][$i]['identifier']['#value'])));

      $results = file_get_contents($solr_url);
      $solr_results = array();
      if (isset($results)) {
          $solr_results = json_decode($results, TRUE);
          $numfound = $solr_results['response']['numFound'];
          if ($numfound > 0) {
              $object_results = $solr_results['response']['docs'];
              foreach ($object_results as $object_index => $object_result)
              {
                  if ($edit_object_pid != $object_result['PID']) {
                      $error_IID_numbers = $error_IID_numbers . $form['id'][$i]['identifier']['#value'] . ' ';
                  }
              }
          }
      }
    }
  }

  if ($iid_count == 0) {
    form_set_error('', t('You must enter an IID identifier.'));
  }

  if (strlen($error_IID_badchars) > 0) {
    form_set_error('', t('The following IID identifiers have illegal characters (characters can be alphanumeric, underscore, hyphen, period, or parentheses with no spaces): %iidnums', array('%iidnums' => $error_IID_badchars)));
  }

  if (strlen($error_IID_numbers) > 0) {
    form_set_error('', t('The following IID identifiers already exist in other objects: %iidnums', array('%iidnums' => $error_IID_numbers)));
  }

  if (strlen($error_IID_bsh) > 0) {
    form_set_error('', t('The following IID identifiers contain the illegal character string "bsh" (please uppercase or replace with other characters): %iidnums', array('%iidnums' => $error_IID_bsh)));
  }

  // other identifiers of type=IID are not allowed
  $other_identifier_count = 0;
  if (isset($form['id_otheridentifiers'])) {
      $other_identifier_count = count($form['id_otheridentifiers']);
  }
  $other_iid_count = 0;
  $error_other_IID_numbers = '';
  for ($i=0; $i<$other_identifier_count; $i++)
  {
    if ( (isset($form['id_otheridentifiers'][$i]['identifier']['#value']))&&(isset($form['id_otheridentifiers'][$i]['type']['#value']))&&(strcasecmp(trim($form['id_otheridentifiers'][$i]['type']['#value']), 'IID') == 0)&&(strlen(trim($form['id_otheridentifiers'][$i]['identifier']['#value'])) > 0) )
    {
      $other_iid_count += 1;
      $error_other_IID_numbers = $error_other_IID_numbers . $form['id_otheridentifiers'][$i]['identifier']['#value'] . ' ';
    }
  }
  if ($other_iid_count > 0) {
    form_set_error('', t('Additional IID identifiers are not allowed.  Change the type for the following identifiers: %iidnums', array('%iidnums' => $error_other_IID_numbers)));
  }

  // check format of purls
  $server_error_purls = '';
  $error_purls = '';

  $location_count = 0;
  if (isset($form['location'])) {
      $location_count = count($form['location']);
  }

  $purl_count = 0;
  for ($i=0; $i<$location_count; $i++)
  {
    if ( (isset($form['location'][$i]['locDispLabel']['#value']))&&(isset($form['location'][$i]['URL']['#value']))&&(strcasecmp($form['location'][$i]['locDispLabel']['#value'], 'PURL') == 0)&&(strlen(trim($form['location'][$i]['URL']['#value'])) > 0) )
    {
      $purl_count += 1;
      $url = trim($form['location'][$i]['URL']['#value']);
      if ((strpos($url,'http://purl.flvc.org') === false)&&(strpos($url,'http://purl.fcla.edu') === false)) {
          $server_error_purls = $server_error_purls . $url . ' ';
      }
      else {
          $purl_id = str_replace('http://purl.flvc.org','',str_replace('http://purl.fcla.edu','',$url));
          $hoststr = '/' . $form['extension']['flvc']['owningInst']['#value'] . '/';
          if ((stripos($purl_id,$hoststr) !== 0)&&(stripos($purl_id,'/flvc/') !== 0)&&(stripos($purl_id,'/fcla/') !== 0)) {
              $error_purls = $error_purls . $url . ' ';
          }
      }
    }
  }

  if (strlen($server_error_purls) > 0) {
    form_set_error('', t('The following PURLs have incorrect server names: %badpurls.  Allowable server names are http://purl.flvc.org or http://purl.fcla.edu only.', array('%badpurls' => $server_error_purls)));
  }

  $domains = $form['extension']['flvc']['owningInst']['#value'];
  if (strcasecmp($domains, 'flvc') != 0) $domains = $domains . ' FLVC';
  $domains = $domains . ' FCLA';

  if (strlen($error_purls) > 0) {
    form_set_error('', t('Allowable PURL domains are %domains.  The following PURLs have incorrect formats: %badpurls', array('%domains' => $domains, '%badpurls' => $error_purls)));
  }

}

function escapeSolrValue($string)
{
    $match = array('\\', '+', '-', '&', '|', '!', '(', ')', '{', '}', '[', ']', '^', '~', '*', '?', ':', '"', ';', ' ');
    $replace = array('\\\\', '\\+', '\\-', '\\&', '\\|', '\\!', '\\(', '\\)', '\\{', '\\}', '\\[', '\\]', '\\^', '\\~', '\\*', '\\?', '\\:', '\\"', '\\;', '\\ ');
    $string = str_replace($match, $replace, $string);
     
    return $string;
}

function flvc_islandora_object_ingested(AbstractObject $object) {

    if (!isset($object['MODS']))
        return;

    $owning_institution = '';
    $purl = '';
    $purl_id = '';

    $mods_str = $object['MODS']->content;
    $mods_xml = new SimpleXMLElement($mods_str);

    // check for owning institution
    $found_owning_inst = FALSE;
    $namespaces = $mods_xml->getNameSpaces(true);
    if ((isset($mods_xml->extension))&&(isset($namespaces['flvc']))) {
        $flvc_entry = $mods_xml->extension->children($namespaces['flvc']);
        if ((count($flvc_entry) == 1)&&(isset($flvc_entry->flvc))) {
            $flvc_fields = $flvc_entry->flvc->children($namespaces['flvc']);
            if (isset($flvc_fields->owningInstitution)&&(strlen($flvc_fields->owningInstitution) > 0)) {
                $found_owning_inst = TRUE;
                $owning_institution = strtolower($flvc_fields->owningInstitution);
            }
        }
    }
    if ($found_owning_inst == FALSE)
        return;

    // check for IID identifier
    $iid_count = 0;
    $digitool_count = 0;
    if (isset($mods_xml->identifier)) {
            foreach ($mods_xml->identifier as $identifier) {
              if (isset($identifier['type'])&&(strcasecmp($identifier['type'], 'IID') == 0)&&(strlen(trim($identifier)) > 0)) {
                $iid_count += 1;
              }
              if (isset($identifier['type'])&&(strcasecmp($identifier['type'], 'digitool') == 0)&&(strlen(trim($identifier)) > 0)) {
                $digitool_count += 1;
              }
            }
    }
    if ($iid_count == 0)
        return;

    // check for PURL
    foreach ($mods_xml->location as $location) {
        $url = $location->url;
        if ((strpos($url,'http://purl.flvc.org') !== false)||(strpos($url,'http://purl.fcla.edu') !== false)) {
            $purl = str_replace('http://purl.fcla.edu','',$url);
            $purl_id = str_replace('http://purl.flvc.org','',$purl);
            $command = '/usr/local/islandora/flvc_purl_scripts/prospective/load-prospective --purl ' . escapeshellarg($purl_id) . ' --own ' . $owning_institution . ' --pid ' . $object->id;
            //drupal_set_message(t($command));
            $execout = array();
            exec($command, $execout);
            foreach ($execout as $msg) {
                if (strpos($msg,'PURLERROR') !== false)
                    drupal_set_message($msg);
            }
        }
    }

    unset($mods_xml);
}

function flvc_islandora_datastream_modified(AbstractObject $object, AbstractDatastream $datastream) {

    if ($datastream->id != 'MODS')
        return;

    if (!isset($object['MODS']))
        return;

    $owning_institution = '';
    $purl = '';
    $purl_id = '';

    $mods_str = $object['MODS']->content;
    $mods_xml = new SimpleXMLElement($mods_str);

    // check for owning institution
    $found_owning_inst = FALSE;
    $namespaces = $mods_xml->getNameSpaces(true);
    if ((isset($mods_xml->extension))&&(isset($namespaces['flvc']))) {
        $flvc_entry = $mods_xml->extension->children($namespaces['flvc']);
        if ((count($flvc_entry) == 1)&&(isset($flvc_entry->flvc))) {
            $flvc_fields = $flvc_entry->flvc->children($namespaces['flvc']);
            if (isset($flvc_fields->owningInstitution)&&(strlen($flvc_fields->owningInstitution) > 0)) {
                $found_owning_inst = TRUE;
                $owning_institution = strtolower($flvc_fields->owningInstitution);
            }
        }
    }
    if ($found_owning_inst == FALSE)
        return;

    // check for IID identifier
    $iid_count = 0;
    $digitool_count = 0;
    if (isset($mods_xml->identifier)) {
            foreach ($mods_xml->identifier as $identifier) {
              if (isset($identifier['type'])&&(strcasecmp($identifier['type'], 'IID') == 0)&&(strlen(trim($identifier)) > 0)) {
                $iid_count += 1;
              }
              if (isset($identifier['type'])&&(strcasecmp($identifier['type'], 'digitool') == 0)&&(strlen(trim($identifier)) > 0)) {
                $digitool_count += 1;
              }
            }
    }
    if ($iid_count == 0)
        return;

    // check for PURL
    foreach ($mods_xml->location as $location) {
        $url = $location->url;
        if ((strpos($url,'http://purl.flvc.org') !== false)||(strpos($url,'http://purl.fcla.edu') !== false)) {
            $purl = str_replace('http://purl.fcla.edu','',$url);
            $purl_id = str_replace('http://purl.flvc.org','',$purl);
            $command = '/usr/local/islandora/flvc_purl_scripts/prospective/load-prospective --purl ' . escapeshellarg($purl_id) . ' --own ' . $owning_institution . ' --pid ' . $object->id;
            //drupal_set_message(t($command));
            $execout = array();
            exec($command, $execout);
            foreach ($execout as $msg) {
                if (strpos($msg,'PURLERROR') !== false)
                    drupal_set_message($msg);
            }
        }
    }

    unset($mods_xml);
}

function flvc_page_alter(&$page) {

  //$content_model = "islandora:collectionCModel";
  $content_model = '';
  $query_root = variable_get('islandora_repository_pid', 'islandora:root');
  $fedora_object = islandora_object_load($query_root);
  $view_pid = '';

  $collection_selected = isset($_GET['collection']) ? $_GET['collection'] : '';
  if (!empty($collection_selected)) {
      $query_pid = $collection_selected;
      $content_model = "islandora:collectionCModel";
  }
  else if (strpos($_SERVER['REQUEST_URI'],'islandora/object/')) {
      $endpos = strpos($_SERVER['REQUEST_URI'], '/', 18);
      if ($endpos === false) {
          $endpos = strpos($_SERVER['REQUEST_URI'], '?', 18);
      }
      if ($endpos) {
          $view_pid = urldecode(substr($_SERVER['REQUEST_URI'],18,$endpos-18));
      }
      else {
          $view_pid = urldecode(substr($_SERVER['REQUEST_URI'],18));
      }
      if ($view_pid == $query_root) {
          $query_pid = $query_root;
          $content_model = "islandora:collectionCModel";
      }
      else {
          $query_pid = $view_pid;
          // query for current object label and hasModel
          $contentquery = <<<'EOQ'
SELECT ?title ?content
FROM <#ri>
WHERE {
  <info:fedora/!pid> <fedora-model:label> ?title;
                     <fedora-model:hasModel> ?content .
FILTER (!sameTerm(?content, <info:fedora/fedora-system:FedoraObject-3.0>))
}
EOQ;
          $formatted_contentquery = format_string($contentquery, array(
            '!pid' => $query_pid,
          ));
          $results = $fedora_object->repository->ri->sparqlQuery($formatted_contentquery, 'unlimited');
          $object_content_type = '';
          $object_title = '';
          if (count($results) > 0) {
              $object_title = $results[0]['title']['value'];
              $object_content_type = $results[0]['content']['value'];
              $content_model = $results[0]['content']['value'];
          }

          if (strpos($object_content_type, 'collectionCModel'))
          {
            $collection_selected = $query_pid;
          }
          else
          {
            // at a non-collection object

            // check for isComponentOf
            $component_of = array();
            $view_object = islandora_object_load($query_pid);
            if ((isset($view_object))&&($view_object != FALSE)) {
              $component_of = $view_object->relationships->get(ISLANDORA_RELS_EXT_URI, 'isComponentOf');
              if (count($component_of) > 0) {
                  $query_pid = $component_of[0]['object']['value'];
              }
            }

            // special processing if at a newspaper issue, newspaper page, book page, intermediate object, or isComponentOf
            if ((strpos($object_content_type, 'pageCModel'))||
                (strpos($object_content_type, 'newspaperIssueCModel'))||
                (strpos($object_content_type, 'newspaperPageCModel'))||
                (strpos($object_content_type, 'intermediateCModel'))||
                (count($component_of) > 0))
            {
                $query_book = <<<'EOQ'
SELECT ?parentObject ?collection
FROM <#ri>
WHERE {
  ?parentObject <fedora-rels-ext:isMemberOfCollection> ?collection .
  <info:fedora/!pid> <fedora-rels-ext:isMemberOf>+ ?parentObject .
}
EOQ;
                $formatted_query_book = format_string($query_book, array(
                  '!pid' => $query_pid,
                ));
                $results = $fedora_object->repository->ri->sparqlQuery($formatted_query_book, 'unlimited');
                if (count($results) > 0) {
                    $query_pid = $results[0]['parentObject']['value'];
                }
            }

            // get the immediate parent collections
            $query_string = <<<'EOQ'
SELECT ?parentObject ?title ?content
FROM <#ri>
WHERE {
  <info:fedora/!pid> <fedora-rels-ext:isMemberOfCollection> ?parentObject .
  ?parentObject <fedora-model:label> ?title;
                <fedora-model:hasModel> ?content;
                <fedora-model:state> <info:fedora/fedora-system:def/model#Active> .
FILTER (!sameTerm(?content, <info:fedora/fedora-system:FedoraObject-3.0>))
FILTER (!sameTerm(?parentObject, <info:fedora/!pid>))
}
ORDER BY DESC(?title)
EOQ;
            $formatted_query_string = format_string($query_string, array(
              '!pid' => $query_pid,
            ));
            $results = $fedora_object->repository->ri->sparqlQuery($formatted_query_string, 'unlimited');
            $query_pid = '';
            foreach ($results as $result) {
                // only add parent collection if namespace matches site root
                $root_namespace = islandora_get_namespace($query_root);
                if (($root_namespace == 'islandora')||(islandora_get_namespace($result['parentObject']['value']) == $root_namespace)) {
                    if (strlen($query_pid) > 0) $query_pid .= ';';
                    $query_pid .= $result['parentObject']['value'];
                }
            }
            //if (count($results) > 0) {
            //    $query_pid = $results[0]['parentObject']['value'];
            //}
          }
      }
  }
  else {
      $query_pid = $query_root;
  }


    $script = 'var _currentCollection = "' . $query_pid  . '";';
    if (strlen($content_model) > 0) {
        $script .= 'var _currentContentModel = "' . $content_model . '";';
    }

    $search_url = '';
    $solr_query = '*';
    if (strpos($_SERVER['REQUEST_URI'],'islandora/search/')) {
      $search_url = '/islandora/search/';
      $endpos = strpos($_SERVER['REQUEST_URI'], '?', 18);
      if ($endpos) {
          $solr_query = urldecode(substr($_SERVER['REQUEST_URI'],18,$endpos-18));
      }
      else {
          $solr_query = urldecode(substr($_SERVER['REQUEST_URI'],18));
      }

      if (trim($solr_query) == '') $solr_query = '*';

      // check for search type
      $search_type = '';
      $colonpos = strpos($solr_query, ':');
      if ($colonpos > 0) {
          $search_type = substr($solr_query,0,$colonpos);
          if (strpos($search_type,'_') > 0) {
              $solr_query = substr($solr_query,$colonpos+1);
          }
          else {
              $search_type = '';
          }
      }

      $search_url .= '?q=' . urlencode($solr_query);

      if (strlen($search_type) > 0) {
          $search_url .= '&searchtype=' . urlencode($search_type);
      }

      $params = $_GET;

      if (isset($params['f']) && is_array($params['f'])) {
          foreach ($params['f'] as $facet) {
              $search_url .= '&c=' . urlencode($facet);
          }
      }

      if (isset($params['collection'])) {
          $search_url .= '&collection=' . urlencode($params['collection']);
      }

      if (isset($params['page'])) {
          $search_url .= '&page=' . urlencode($params['page']);
      }

      $script .= 'var _trackSearch = "' . $search_url . '";';

    }

    if ((strlen($content_model) > 0)&&($content_model == 'islandora:intermediateCModel')) {
        $pdf_query = <<<EOQ
SELECT ?pdf FROM <#ri> WHERE {
  ?pdf <http://islandora.ca/ontology/relsext#isComponentOf> <info:fedora/!pid>
  }
EOQ;
        $pdf_query = format_string($pdf_query, array(
          '!pid' => $view_pid,
        ));
        $pdf_count = 0;
        $results = $fedora_object->repository->ri->sparqlQuery($pdf_query);
        foreach ($results as $result) {
          $pdf_id = $result['pdf']['value'];
          $pdf_count++;
        }
        if (($pdf_count == 1)&&(!user_is_logged_in())) {
            drupal_goto('islandora/object/' . $pdf_id);
        }

    }

    drupal_add_js($script, array('scope' => 'header', 'type' => 'inline'));
 
}

/**
 * Implements hook_islandora_edit_datastream_registry().
 */
function flvc_islandora_edit_datastream_registry(AbstractObject $object, AbstractDatastream $datastream) {
  if (($datastream->id == 'TOC')&&(user_has_role(user_role_load_by_name('administrator')->rid))) {
    return array(
      array(
        'Name' => t('edit table of contents'),
        'url' => "islandora/tree_edit/{$object->id}/{$datastream->id}",
        'weight' => 6,
      ),
    );
  }
}

/**
 * Admin autocomplete callback which returns solr fields from Luke.
 *
 * @param string $string
 *   String filled out in the autocomplete textfield.
 *
 * @return json
 *   A json array containing the Solr luke values that contain the given string.
 */
function flvc_solr_autocomplete_text_fields($string = '') {

  $luke = islandora_solr_get_luke();
  $result = array();
  foreach ($luke['fields'] as $term => $value) {
    if ((stripos($term, '_mt') !== FALSE)&&(stripos(str_replace('_','.',$term), $string) !== FALSE)) {
      $term2 = str_replace('_mt','',$term);
      $term3 = str_replace('_','.',$term2);

      // Search case insensitive, but keep the case on replace.
      $term_str = preg_replace("/$string/i", "<strong>\$0</strong>", $term3);

      // Add strong elements to highlight the found string.
      $result[$term3] = $term_str . '<strong style="position: absolute; right: 5px;">(' . $value['type'] . ')</strong>';
    }
  }
  // Sort alphabetically.
  ksort($result);

  drupal_json_output($result);
  exit();
}

/**
 * Admin autocomplete callback which returns solr fields from Luke.
 *
 * @param string $string
 *   String filled out in the autocomplete textfield.
 *
 * @return json
 *   A json array containing the Solr luke values that contain the given string.
 */
function flvc_solr_autocomplete_string_fields($string = '') {

  $luke = islandora_solr_get_luke();
  $result = array();
  foreach ($luke['fields'] as $term => $value) {
    if ((stripos($term, '_ms') !== FALSE)&&(stripos(str_replace('_','.',$term), $string) !== FALSE)) {
      $term2 = str_replace('_ms','',$term);
      $term3 = str_replace('_','.',$term2);

      // Search case insensitive, but keep the case on replace.
      $term_str = preg_replace("/$string/i", "<strong>\$0</strong>", $term3);

      // Add strong elements to highlight the found string.
      $result[$term3] = $term_str . '<strong style="position: absolute; right: 5px;">(' . $value['type'] . ')</strong>';
    }
  }
  // Sort alphabetically.
  ksort($result);

  drupal_json_output($result);
  exit();
}

function flvc_google_analytics_all_views() {
  $output = views_embed_view('top_site_searches');
  $output .= views_embed_view('top_facet_searches');
  return $output;
}

/**
 * Implements hook_CMODEL_PID_islandora_view_object().
 */
function flvc_islandora_collectionCModel_islandora_view_object(AbstractObject $object) {

  $display_empty_view = variable_get('flvc_display_view_for_empty_collections', FALSE);
  if ($display_empty_view) {
    $child_query =  <<<EOQ
SELECT ?object FROM <#ri> WHERE {
  ?object <fedora-rels-ext:isMemberOfCollection> <info:fedora/!pid> ;
        <fedora-model:state> <fedora-model:Active> .
}
EOQ;
    $child_query = format_string($child_query, array(
      '!pid' => $object->id,
    ));
    $count = $object->repository->ri->countQuery($child_query, 'sparql');
    if ($count == 0) {
      return;
    }

  }

  // determine number of child collection objects
  $collection_query =  <<<EOQ
SELECT ?object FROM <#ri> WHERE {
  ?object <fedora-rels-ext:isMemberOfCollection> <info:fedora/!pid> ;
        <fedora-model:hasModel> <info:fedora/islandora:collectionCModel> ;
        <fedora-model:state> <fedora-model:Active> .
}
EOQ;
  $collection_query = format_string($collection_query, array(
    '!pid' => $object->id,
  ));
  $count = $object->repository->ri->countQuery($collection_query, 'sparql');

  // if no child collection objects and user not logged in, redirect to search display
  if (($count == 0)&&(!user_is_logged_in())) {
    $params = array('type' => 'edismax', 'collection' => $object->id);
    drupal_goto('islandora/search/', array('query' => $params));
  }

  // if no child collection objects and PALMM site and user not admin, redirect to search display
  if (($count == 0)&&(substr($object->id, 0, 5) == 'palmm')&&(!user_has_role(user_role_load_by_name('administrator')->rid))) {
    $params = array('type' => 'edismax', 'collection' => $object->id);
    drupal_goto('islandora/search/', array('query' => $params));
  }

}


/**
 * Implements hook_islandora_object_alter().
 */
function flvc_islandora_object_alter(AbstractObject $object, array &$context) {

  // Set state to 'D' instead of deleting object 
  //if ($context['action'] == 'purge') {
  //  $context['delete'] = TRUE;
  //}

  // if state change to active, block if IID exists
  if ($context['action'] == 'modify') {
    if ((isset($context['params']['state']))&&($context['params']['state'] == 'A')&&(isset($object['MODS']))) {
      $mods_str = $object['MODS']->content;
      $mods_xml = new SimpleXMLElement($mods_str);

      // check for IID identifier
      if (isset($mods_xml->identifier)) {
        foreach ($mods_xml->identifier as $identifier) {
          if (isset($identifier['type'])&&(strcasecmp($identifier['type'], 'IID') == 0)&&(strlen(trim($identifier)) > 0)) {
            $solr_url = "http://localhost:8080/solr/select/?version=2.2&start=0&rows=10&indent=on&fl=PID&wt=json&q=mods_identifier_iid_mls%3A" . urlencode(escapeSolrValue(trim($identifier)));
            $results = file_get_contents($solr_url);
            $solr_results = array();
            if (isset($results)) {
              $solr_results = json_decode($results, TRUE);
              $numfound = $solr_results['response']['numFound'];          
              if ($numfound > 0) {              
                drupal_set_message(t('The IID identifier %iidnum already exists. A unique IID identifier is required before changing the state to Active.', array('%iidnum' => $identifier)), $type = 'error');
                $context['block'] = TRUE;
              }
            }
          }
        }
      }
    }
  }

}

function flvc_islandora_solr_query($islandora_solr_query) {
  // check site configuration to include collection objects in user searches
  $include_collections = variable_get('flvc_include_collections_in_search', FALSE);
  if (!($include_collections)) {
      if (strstr(current_path(), 'islandora/search')) {
        $islandora_solr_query->solrParams['fq'][] = '-RELS_EXT_hasModel_uri_ms:info\:fedora/islandora\:collectionCModel';
      }
  }
}

function flvc_islandora_datastream_alter(AbstractObject $object, AbstractDatastream $datastream, array &$context) {

  if (($datastream->id == 'MODS')&&($context['action'] == 'modify')) {
  //drupal_set_message('in datastream_alter for modify');
    if ((isset($context['params']))&&(isset($context['params']['dsFile']))) {
      //drupal_set_message('found dsFile for modify');
      $mods_str = file_get_contents($context['params']['dsFile']);
      $msg = flvc_validate_MODS($object, $mods_str);
      if (strlen($msg) > 0) {
        drupal_set_message('Datastream replace failed due to invalid MODS - ' . $msg, 'warning');
        $context['block'] = TRUE;
      }
    }
  }

  if (($datastream->id == 'MODS')&&($context['action'] == 'create')) {
  drupal_set_message('in datastream_alter for create');
    if ((isset($context['params']))&&(isset($context['params']['dsFile']))) {
      drupal_set_message('found dsFile for create');
    }
  }

}

function flvc_validate_MODS(AbstractObject $object, $xmlstring) {

  $error_IID_numbers = '';
  $error_IID_badchars = '';
  $error_IID_bsh = '';
  $iid_count = 0;

  // if there was no xml, do not validate
  if ((!isset($xmlstring)) || (strlen($xmlstring)==0)) {
    return 'Metadata file is empty';
  }

  $mods_xml = new SimpleXMLElement($xmlstring);

  $namespaces = $mods_xml->getNameSpaces(true);

  // check for title
  $found_title = FALSE;
  if (isset($mods_xml->titleInfo->title)) {
    $found_title = TRUE;
  }
  if ($found_title == FALSE) {
    return 'Metadata is missing the title';
  }

  // check for owningInstitution
  $owning_institution = '';
  $found_owning_inst = FALSE;
  if (isset($namespaces['flvc'])) {
    foreach ($mods_xml->extension as $extension) {
      $flvc_entry = $extension->children($namespaces['flvc']);
      if ((count($flvc_entry) == 1)&&(isset($flvc_entry->flvc))) {
        $flvc_fields = $flvc_entry->flvc->children($namespaces['flvc']);
        if (isset($flvc_fields->owningInstitution)&&(strlen($flvc_fields->owningInstitution) > 0)) {
          $owning_institution = trim($flvc_fields->owningInstitution);
          $found_owning_inst = TRUE;
        }
      }
      else {
        return 'Metadata must have one extension->flvc';
      }
    }
  }
  else {
    return 'Metadata has no flvc namespace';
  }
  if ($found_owning_inst == FALSE) {
    return 'Metadata has no owningInstitution';
  }

  //check for IID identifier
  if (isset($mods_xml->identifier)) {
    foreach ($mods_xml->identifier as $identifier) {
      if (isset($identifier['type'])&&(strcasecmp($identifier['type'], 'IID') == 0)&&(strlen(trim($identifier)) > 0)) {
        $iid_count += 1;

        if (preg_match("/[^A-Za-z0-9_\-()\.]/", trim($identifier))) {
          $error_IID_badchars .= trim($identifier) . ' ';
        }

        if (strpos(trim($identifier), "bsh") !== false) {
          $error_IID_bsh .= trim($identifier) . ' ';
        }

        $solr_url = "http://localhost:8080/solr/select/?version=2.2&start=0&rows=10&indent=on&fl=PID&wt=json&q=mods_identifier_iid_mls%3A" . urlencode(escapeSolrValue(trim($identifier)));
        $results = file_get_contents($solr_url);
        $solr_results = array();
        if (isset($results)) {
          $solr_results = json_decode($results, TRUE);
          $numfound = $solr_results['response']['numFound'];
          if ($numfound > 0) {
            $object_results = $solr_results['response']['docs'];
            foreach ($object_results as $object_index => $object_result)
            {
              if ($object->id != $object_result['PID']) {
                $error_IID_numbers = $error_IID_numbers . trim($identifier) . ' ';
              }
            }
          }
        }
      }
    }
  }
  if ($iid_count == 0) {
    return 'Metadata has no IID identifier';
  }
  if ($iid_count > 1) {
    return 'Metadata has more than one IID identifier';
  } 
  if (strlen($error_IID_badchars) > 0) {
    return 'The IID identifier has illegal characters (characters can be alphanumeric, underscore, hyphen, period, or parentheses with no spaces):' . $error_IID_badchars;
  }
  if (strlen($error_IID_numbers) > 0) {
    return 'The IID identifier already exists: ' . $error_IID_numbers;
  }

  if (strlen($error_IID_bsh) > 0) {
    return 'The following IID identifiers contain the illegal character string "bsh" (please uppercase or replace with other characters): ' . $error_IID_bsh;
  }

  // check format of purls
  $server_error_purls = '';
  $error_purls = '';
  foreach ($mods_xml->location as $location) {
    $url = $location->url;
    if (isset($location['displayLabel'])&&(strcasecmp($location['displayLabel'], 'purl') == 0)) {
      if ((strpos($url,'http://purl.flvc.org') === false)&&(strpos($url,'http://purl.fcla.edu') === false)) {
        $server_error_purls = $server_error_purls . $url . ' ';
      }
    }
    if ((strpos($url,'http://purl.flvc.org') !== false)||(strpos($url,'http://purl.fcla.edu') !== false)) {
      $purl_id = str_replace('http://purl.flvc.org','',str_replace('http://purl.fcla.edu','',$url));
      $hoststr = '/' . $owning_institution . '/';
      if (stripos($purl_id,$hoststr) !== 0) {
        $error_purls = $error_purls . $url . ' ';
      }
    }
  }
  if (strlen($server_error_purls) > 0) {
    return t('The following PURLs have incorrect server names: %badpurls', array('%badpurls' => $server_error_purls));
  }
  if (strlen($error_purls) > 0) {
    return t('Allowable PURL domains are %domains.  The following PURLs have incorrect formats: %badpurls', array('%domains' => $owning_institution, '%badpurls' =>$error_purls));
  }

  return '';
}
